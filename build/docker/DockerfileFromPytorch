ARG TORCH_VERDION=2.3.1
ARG CUDA_VERSION=cuda12.1
ARG CUDNN_VERSION=cudnn8
# base runtime devel
ARG PUBLISH_VERSION=devel
ARG PYTHON_VERSION=python3.10

FROM pytorch/pytorch:${TORCH_VERDION}-${CUDA_VERSION}-${CUDNN_VERSION}-${PUBLISH_VERSION} as base

# Set environment variables
# ENV LANG=C.UTF-8 \ 
#   LC_ALL=C.UTF-8 \
#   LANGUAGE=en_US:en \
#   TZ=Asia/Shanghai

ENV LANG=C.UTF-8 \ 
  LC_ALL=C.UTF-8 \
  TZ=Asia/Shanghai

WORKDIR /app

# Set up timezone
# install
RUN --mount=type=bind,source=requirementsTorch.txt,target=requirements.txt \
  --mount=type=bind,source=build/wheels,target=/wheels \
  ln -fs /usr/share/zoneinfo/Asia/Hong_Kong /etc/localtime && echo 'Asia/Shanghai' > /etc/time  \
  && set -ex \
  && apt-get update \
  && apt-get install -y --no-install-recommends libgl1 libgl1-mesa-glx libglib2.0-0 ca-certificates supervisor  \
  && pip install -r requirements.txt \
  && pip install /wheels/GDAL-3.9.1-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl \
  && adduser --uid 10001 --disabled-password --gecos "" --home "/home/appuser" appuser \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/*  /tmp/* /var/tmp/* \
  && rm -rf /var/cache/apk/*

COPY build/docker/supervisord.conf /etc/supervisor/conf.d/supervisord.conf
COPY build/docker/supervisord.conf /app/build/docker/supervisord.conf

RUN set -ex \
  && chmod 777 /etc/supervisor \
  && chown -R appuser:appuser /app 

# Switch to the non-privileged user to run the application.
USER appuser

# Copy the source code into the container.
# COPY . .

# method 2 not debuged
# COPY build/docker/start.sh /app/start.sh
# RUN  chmod +x /app/start.sh 

# Expose the port that the application listens on.
EXPOSE 55177

HEALTHCHECK CMD curl -fs http://localhost:55177/ais/api/v1/health || exit 1

# Run the application.
ENTRYPOINT ["/usr/bin/supervisord", "-n"]

# devel 20 GB
